<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
<style>
  * { box-sizing: border-box; }
  body {
    margin: 0;
    padding: 0;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    font-size: 13px;
    line-height: 1.5;
    color: #a3a3a3;
    background: #0a0a0a;
    min-height: 100%;
    overflow-y: auto;
  }

  p { margin-block-start: 0; margin-block-end: 0; }

  .container {
    max-width: 100%;
    min-height: 280px;
  }

  /* Centered initial view */
  .hero {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 24px 20px;
    min-height: 200px;
  }
  .hero-inner {
    width: 100%;
    max-width: 260px;
    text-align: center;
  }
  .hero h1 {
    margin: 0 0 6px 0;
    font-size: 20px;
    font-weight: 600;
    color: #e5e5e5;
    letter-spacing: -0.02em;
  }
  .hero p {
    margin: 0 0 20px 0;
    font-size: 12px;
    color: #737373;
  }
  .tabs {
    display: flex;
    padding: 3px;
    background: #1a1a1a;
    border-radius: 8px;
    gap: 2px;
    margin-bottom: 14px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.2);
  }
  .tab {
    flex: 1;
    padding: 8px 12px;
    background: none;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 12px;
    font-weight: 500;
    color: #737373;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    transition: color 0.15s, background 0.15s;
  }
  .tab:hover { color: #a3a3a3; background: #1f1f1f; }
  .tab.active { color: #e5e5e5; background: #262626; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
  .tab:focus-visible { outline: 2px solid #525252; outline-offset: 2px; }
  .tab svg { flex-shrink: 0; }

  .btn-export {
    width: fit-content;
    height: 40px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 12px 16px;
    font-size: 13px;
    font-weight: 600;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    background: #002beb;
    color: #fafafa;
    box-shadow: 0 2px 8px rgba(0,0,0,0.25);
    transition: background 0.15s, box-shadow 0.15s;
  }
  .btn-export:hover { background: #0835ff; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
  .btn-export:focus-visible { outline: 2px solid #525252; outline-offset: 2px; }
  .btn-export svg { flex-shrink: 0; }

  .btn-export .btn-export-dots {
    display: none;
    align-items: center;
    justify-content: center;
    gap: 4px;
  }
  .btn-export.loading .btn-export-text { display: none; }
  .btn-export.loading .btn-export-dots { display: inline-flex; }
  .btn-export.loading { pointer-events: none; }
  .btn-export-dot {
    width: 4px;
    height: 4px;
    border-radius: 50%;
    background: currentColor;
    animation: dot-bounce 0.6s ease-in-out infinite both;
  }
  .btn-export-dot:nth-child(2) { animation-delay: 0.1s; }
  .btn-export-dot:nth-child(3) { animation-delay: 0.2s; }
  @keyframes dot-bounce {
    0%, 80%, 100% { transform: scale(0.6); opacity: 0.5; }
    40% { transform: scale(1); opacity: 1; }
  }

  /* Expandable code preview */
  .preview-wrapper {
    display: grid;
    grid-template-rows: 0fr;
    transition: grid-template-rows 0.4s ease-out;
    overflow: hidden;
  }
  .preview-wrapper.expanded {
    grid-template-rows: 1fr;
  }
  .preview-inner {
    min-height: 0;
    overflow: hidden;
  }
  .output-section {
    padding: 0 16px 0 16px;
    animation: fadeIn 0.35s ease-out;
  }
  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }
  .code-view {
    border-radius: 10px;
    box-shadow: 0 2px 12px rgba(0,0,0,0.25);
    overflow: hidden;
  }
  .code-tabs {
    display: flex;
    gap: 0;
    background: none;
    min-height: 36px;
  }
  .code-tab {
    padding: 6px 14px;
    background: none;
    border: none;
    border-radius: 8px 8px 0 0;
    cursor: pointer;
    font-size: 12px;
    font-weight: 500;
    color: #737373;
    transition: color 0.15s, background 0.15s;
  }
  .code-tab:hover { color: #a3a3a3; }
  .code-tab.active {
    color: #e5e5e5;
    background: #1a1a1a;
  }
  .code-tab:focus-visible { outline: 2px solid #525252; outline-offset: -2px; }
  .code-content { 
    background: #1a1a1a; 
    border-radius: 10px;
  }
  .code-panel {
    display: none;
    flex-direction: column;
    overflow: hidden;
    position: relative;
  }
  .code-panel.active { display: flex; }
  .code-panel-header {
    position: absolute;
    top: 0;
    right: 0;
    z-index: 1;
    padding: 8px;
    background: none;
  }
  .code-panel-actions { display: flex; gap: 4px; }
  .code-area-wrap {
    flex: 1;
    position: relative;
    min-height: 190px;
  }
  .code-display {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    margin: 0;
    padding: 10px 12px;
    overflow: auto;
    font-family: 'SF Mono', 'Monaco', 'Inconsolata', Consolas, monospace;
    font-size: 11px;
    line-height: 1.5;
    background: #1a1a1a;
    border-radius: 0;
  }
  .code-display pre {
    margin: 0;
    padding: 0;
    background: none;
    font-size: inherit;
    line-height: inherit;
  }
  .code-display code {
    font-family: inherit;
    font-size: inherit;
    line-height: inherit;
    color: #d4d4d4;
  }
  .code-display:empty::before {
    content: 'Exported code will appear here…';
    color: #525252;
    font-style: normal;
  }
  .code-area {
    position: absolute;
    left: -9999px;
    width: 1px;
    height: 1px;
    opacity: 0;
    pointer-events: none;
  }

  .btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    padding: 8px 12px;
    font-size: 12px;
    font-weight: 500;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    transition: background 0.15s, color 0.15s, box-shadow 0.15s;
  }
  .btn:focus-visible { outline: 2px solid #525252; outline-offset: 2px; }
  .btn svg { flex-shrink: 0; }
  .btn-ghost { background: transparent; color: #737373; box-shadow: none; }
  .btn-ghost:hover { background: #1f1f1f; color: #a3a3a3; }
  .btn-icon { padding: 8px; min-width: 32px; }

  /* Download bar – inside expanded preview, in flow */
  .bottom-bar {
    padding: 12px 16px 16px 16px;
  }
  .btn-download {
    width: 100%;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 10px 16px;
    font-size: 12px;
    font-weight: 500;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    background: #262626;
    color: #e5e5e5;
    box-shadow: 0 1px 4px rgba(0,0,0,0.2);
    transition: background 0.15s, box-shadow 0.15s;
  }
  .btn-download:hover { background: #333; box-shadow: 0 2px 6px rgba(0,0,0,0.25); }
  .btn-download:focus-visible { outline: 2px solid #525252; outline-offset: 2px; }

  .toast {
    position: fixed;
    bottom: 16px;
    left: 16px;
    right: 16px;
    padding: 12px 14px;
    font-size: 12px;
    background: #262626;
    border-radius: 8px;
    color: #e5e5e5;
    opacity: 0;
    transform: translateY(10px);
    pointer-events: none;
    transition: opacity 0.2s, transform 0.2s;
    z-index: 100;
    display: flex;
    align-items: center;
    gap: 10px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.4);
  }
  .toast.visible { opacity: 1; transform: translateY(0); }
  .toast-icon { flex-shrink: 0; }
  .toast.success .toast-icon { color: #22c55e; }
  .toast.error .toast-icon { color: #ef4444; }
  .toast.info .toast-icon { color: #737373; }
</style>

<div class="container">
  <div class="hero">
    <div class="hero-inner">
      <h1>Figma to Codes</h1>
      <p>Select an auto-layout frame, then export.</p>
      <div class="tabs" role="tablist">
        <button type="button" class="tab active" data-format="html" role="tab" aria-selected="true">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 18l6-6-6-6"/><path d="M8 6v12"/></svg>
          HTML + CSS
        </button>
        <button type="button" class="tab" data-format="react" role="tab" aria-selected="false">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/></svg>
          React
        </button>
      </div>
      <button type="button" id="export" class="btn-export">
        <span class="btn-export-text">Export Selected Frames</span>
        <span class="btn-export-dots" aria-hidden="true">
          <span class="btn-export-dot"></span>
          <span class="btn-export-dot"></span>
          <span class="btn-export-dot"></span>
        </span>
      </button>
    </div>
  </div>

  <div id="preview-wrapper" class="preview-wrapper">
    <div class="preview-inner">
      <section class="output-section">
        <div class="code-view">
          <div class="code-tabs" role="tablist">
            <button type="button" class="code-tab active" data-panel="output" role="tab" aria-selected="true" id="tab-output">HTML</button>
            <button type="button" class="code-tab" data-panel="css" role="tab" aria-selected="false" id="tab-css">CSS</button>
          </div>
          <div class="code-content">
            <div class="code-panel active" id="panel-output" role="tabpanel" aria-labelledby="tab-output">
              <div class="code-panel-header">
                <div class="code-panel-actions">
                  <button type="button" class="btn btn-ghost btn-icon copy-btn" data-target="output" title="Copy">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
                  </button>
                </div>
              </div>
              <div class="code-area-wrap">
                <div class="code-display" id="output-display" aria-hidden="true"></div>
                <textarea id="output" class="code-area" rows="1" aria-label="Exported markup"></textarea>
              </div>
            </div>
            <div class="code-panel" id="panel-css" role="tabpanel" aria-labelledby="tab-css">
              <div class="code-panel-header">
                <div class="code-panel-actions">
                  <button type="button" class="btn btn-ghost btn-icon copy-btn" data-target="css" title="Copy">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
                  </button>
                </div>
              </div>
              <div class="code-area-wrap">
                <div class="code-display" id="css-display" aria-hidden="true"></div>
                <textarea id="css" class="code-area" rows="1" aria-label="Exported CSS"></textarea>
              </div>
            </div>
          </div>
        </div>
      </section>
      <footer class="bottom-bar">
        <button type="button" id="download-zip" class="btn-download">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
          Download ZIP
        </button>
      </footer>
    </div>
  </div>
</div>

<div id="toast" class="toast info" aria-live="polite">
  <span class="toast-icon" aria-hidden="true">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
  </span>
  <span class="toast-message"></span>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-markup.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-css.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-jsx.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script>
  let exportFormat = 'html';

  function renderHighlightedCode(displayId, code, language) {
    var el = document.getElementById(displayId);
    if (!el || typeof Prism === 'undefined') return;
    if (!code) {
      el.innerHTML = '';
      return;
    }
    try {
      var grammar = Prism.languages[language];
      var highlighted = grammar ? Prism.highlight(code, grammar, language) : Prism.util.encode(code);
      el.innerHTML = '<pre class="code-pre"><code class="language-' + language + '">' + highlighted + '</code></pre>';
    } catch (e) {
      el.innerHTML = '<pre class="code-pre"><code>' + Prism.util.encode(code) + '</code></pre>';
    }
  }

  function setToastMessage(el, message) {
    const msgEl = el.querySelector('.toast-message');
    if (msgEl) msgEl.textContent = message;
  }

  function showToast(message, status) {
    const el = document.getElementById('toast');
    setToastMessage(el, message);
    el.className = 'toast visible ' + (status || 'info');
    const icon = el.querySelector('.toast-icon');
    if (icon) {
      if (status === 'success') {
        icon.innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg>';
      } else if (status === 'error') {
        icon.innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>';
      } else {
        icon.innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>';
      }
    }
    clearTimeout(el._tid);
    el._tid = setTimeout(function() { el.classList.remove('visible'); }, 3200);
  }

  function setExportLoading(loading) {
    var btn = document.getElementById('export');
    if (btn) btn.classList.toggle('loading', loading);
  }

  function setPreviewExpanded(expanded) {
    document.getElementById('preview-wrapper').classList.toggle('expanded', expanded);
  }

  function copyToClipboard(id) {
    var el = document.getElementById(id);
    var text = el.value;
    if (!text) {
      showToast('Nothing to copy.', 'info');
      return;
    }
    function fallbackCopy() {
      var ta = document.createElement('textarea');
      ta.value = text;
      ta.style.position = 'fixed';
      ta.style.left = '-9999px';
      ta.style.top = '0';
      document.body.appendChild(ta);
      ta.focus();
      ta.select();
      try {
        var ok = document.execCommand('copy');
        if (ok) showToast('Copied to clipboard.', 'success');
        else showToast('Copy failed.', 'error');
      } catch (e) {
        showToast('Copy failed.', 'error');
      }
      document.body.removeChild(ta);
    }
    if (navigator.clipboard && typeof navigator.clipboard.writeText === 'function') {
      navigator.clipboard.writeText(text).then(function() {
        showToast('Copied to clipboard.', 'success');
      }).catch(function() {
        fallbackCopy();
      });
    } else {
      fallbackCopy();
    }
  }

  document.querySelectorAll('.tab').forEach(function(tab) {
    tab.onclick = function() {
      document.querySelectorAll('.tab').forEach(function(t) {
        t.classList.remove('active');
        t.setAttribute('aria-selected', 'false');
      });
      tab.classList.add('active');
      tab.setAttribute('aria-selected', 'true');
      exportFormat = tab.dataset.format;
    };
  });

  document.querySelectorAll('.code-tab').forEach(function(btn) {
    btn.onclick = function() {
      var panelId = btn.dataset.panel;
      document.querySelectorAll('.code-tab').forEach(function(b) {
        b.classList.toggle('active', b.dataset.panel === panelId);
        b.setAttribute('aria-selected', b.dataset.panel === panelId ? 'true' : 'false');
      });
      document.querySelectorAll('.code-panel').forEach(function(p) {
        p.classList.toggle('active', p.id === 'panel-' + panelId);
      });
    };
  });

  document.getElementById('export').onclick = function() {
    setExportLoading(true);
    showToast('Exporting…', 'info');
    parent.postMessage({ pluginMessage: { type: 'export', format: exportFormat } }, '*');
  };

  document.getElementById('download-zip').onclick = function() {
    var output = document.getElementById('output').value;
    var css = document.getElementById('css').value;
    if (!output || !css) {
      showToast('Export first to download.', 'error');
      return;
    }
    showToast('Preparing ZIP…', 'info');
    var zip = new JSZip();
    if (exportFormat === 'react') {
      zip.file('Component.jsx', output);
    } else {
      zip.file('index.html', output);
    }
    zip.file('styles.css', css);
    zip.generateAsync({ type: 'blob' }).then(function(blob) {
      var url = URL.createObjectURL(blob);
      var a = document.createElement('a');
      a.href = url;
      a.download = 'figma-export.zip';
      a.click();
      URL.revokeObjectURL(url);
      showToast('ZIP downloaded.', 'success');
    }).catch(function() { showToast('Download failed.', 'error'); });
  };

  document.querySelectorAll('.copy-btn').forEach(function(btn) {
    btn.onclick = function() { copyToClipboard(btn.dataset.target); };
  });

  onmessage = function(event) {
    var msg = event.data && event.data.pluginMessage;
    if (!msg || !msg.type) return;
    if (msg.type === 'export-result') {
      setExportLoading(false);
      var content = msg.jsx != null ? msg.jsx : msg.html;
      var receivedFormat = msg.format || (msg.jsx != null ? 'react' : 'html');
      var outputEl = document.getElementById('output');
      var cssEl = document.getElementById('css');
      outputEl.value = content || '';
      cssEl.value = msg.css || '';
      if (msg.format != null || msg.jsx != null) {
        exportFormat = receivedFormat;
        document.querySelectorAll('.tab').forEach(function(t) {
          var active = t.dataset.format === receivedFormat;
          t.classList.toggle('active', active);
          t.setAttribute('aria-selected', active ? 'true' : 'false');
        });
      }
      var tabOutput = document.getElementById('tab-output');
      if (tabOutput) tabOutput.textContent = exportFormat === 'react' ? 'JSX' : 'HTML';
      setPreviewExpanded(true);
      showToast('Export complete.', 'success');
      setTimeout(function() {
        var markupLang = exportFormat === 'react' ? 'jsx' : 'markup';
        renderHighlightedCode('output-display', outputEl.value, markupLang);
        renderHighlightedCode('css-display', cssEl.value, 'css');
      }, 0);
    }
    if (msg.type === 'error') {
      setExportLoading(false);
      showToast(msg.message || 'Something went wrong.', 'error');
    }
  };
</script>
